{% extends "master.html" %}

{% load humanize %}

{% block sidebar %}
    <div id="rightmenu">
        <a href="{% url story_from_backlog current_project.id %}?last_page={{last_page}}">
            <span class="action-link add-object">Add User Story</span>
        </a>

        {% if full_backlog %}
            <a href="{{ full_backlog }}?last_page={{last_page}}">Backlog in Excel format</a>
        {% endif %}

        {% if product_backlog_chart %}
            <a target="_chart" href="{{ product_backlog_chart }}?last_page={{last_page}}">Backlog evolution</a>
        {% endif %}
    </div>
{% endblock %}


{% block link %}
    <link rel="alternate" type="application/rss+xml"
        title="Product backlog for {{current_project.name}}"
        href="/feeds/backlog/{{current_project.id}}/" />
{% endblock %}

{% block js %}
    <script type="text/javascript" src="/agilito/js/jquery.tablednd_0_5.js"></script>
    <script type="text/javascript" src="/agilito/js/jquery.uitablefilter.js"></script>

    <script type="text/javascript">
        function select_states() {
            var states = [];
            {% for state in states %}
                if ($("#story_state_{{state.state}}").is(':checked')) {
                    states.push('{{state.state}}');
                }
            {% endfor %}
            states = states.join('+');
            if (states != '') {
                states += '/';
            }
            window.location = '{{default_backlog}}' + states;
        }

        $(document).ready(function() {
            $("#user-story-list").tableDnD({
                onDragClass: "dragging",

                onDrop: function(table, row) {
                    var rows = table.tBodies[0].rows;

                    var pred = 'first';
                    for (var i=0; i<rows.length; i++) {
                        if (row.id == rows[i].id) {
                            break;
                        }
                        pred = rows[i].id;
                    }
                    
                    var goto = window.location.href + '/reorder/' + row.id + '/' + pred + '/';
                    window.location = goto;
                }
            });

            var pbl = $('#user-story-list')

            $("#filter").keyup(function() {
                $.uiTableFilter( pbl, this.value );
            })

            {% for state in states %}
                $("#story_state_{{state.state}}").change(select_states);
            {% endfor %}
        });
    </script>
{% endblock %}

{% block title %} User Stories in the Backlog {% endblock %}

{% if current_project %}
    {% block select_tab %} "backlog" {% endblock %}

    {% block content %}
        <h2>
            {% if current_project %}
                {{ current_project.name }} &raquo;
                {% if current_project.release %}
                    Release: {{current_project.release.name}} &raquo;
                {% endif %}
            {% endif %}
    
            Backlog
        </h2>

        {% if backlog %}
            <div id="us-resume">
                <span>Number of US in Backlog: <strong>{{ user_stories_count }}</strong> </span> 
                {% if velocity.sprint_length %}
                    <div>Velocity: {{ velocity.actual }} vs. {{ velocity.estimated }} (avg sprint length {{ velocity.sprint_length|floatformat:0 }} days)</div>
                {% endif %}
                {% if accuracy %}
                    <div>Sizing accuracy: {{ accuracy|floatformat:0 }}%</div>
                {% endif %}
                <div>
                    <form name="states">
                        {% for state in states %}
                            <input type="checkbox"
                                id="story_state_{{state.state}}"
                                name="story_state_{{state.state}}"
                                value="{{ state.state }}"
                                {% if state.selected %}
                                    checked="checked"
                                {% endif %}
                                />&nbsp;<label class="inline"
                                    for="story_state_{{state.state}}">{{state.name}}</label>
                        {% endfor %}
                    </form>
                </div>
            </div>
        {% endif %}
    
        {% if backlog %}
            <form id="filter-form">Filter: <input name="filter" id="filter" value="" maxlength="30" size="30" type="text"></form>
            <table cellspacing="0" cellpadding="2" id="user-story-list">
                <thead>
                    <tr class="nodrop nodrag">
                        <th>Rank</th>
                        <th>Id</th>
                        <th>Name</th>
                        <th>Size</th>
                        <th>Suggested size</th>
                        <th>State</th>
                        <th><!-- edit --></th>
                        <th><!-- move --></th>
                        <th><!-- delete --></th>
                    </tr>
                </thead>
    
                <tbody>
                    <tr class="totals nodrop nodrag">
                        <td><!-- rank --></td>
                        <td><!-- id --></td>
                        <td><!-- name --></td>
                        <td class="total size">{{ size }}</td>
                        <td><!-- suggested size --></td>
                        <td><!-- state --></td>
                        <td><!-- edit --></td>
                        <td><!-- move --></td>
                        <td><!-- delete --></td>
                    </tr>
    
                    {% for story in backlog %}
                        {% ifequal story.whatami "UserStory" %}
                            <tr id="us_{{story.id}}_{{story.rank}}" class="{% cycle even,odd %}">
                                <td class="rank">{{story.rank}}</td>
                                <td class="id">US{{story.id}}</td>
                                <td class="name"><a href="{{story.get_absolute_url}}">{{story.name}}</a>
                                    <ul class="tags">
                                        {% for tag in story.taglist %}
                                            <li><span class="small">{{ tag }}</span></li>
                                        {% endfor %}
                                    </ul>
                                </td>
                                <td class="size">{{story.size_label|default_if_none:"-"}}</td>
                                <td class="size">{{story.suggested_size|default_if_none:"-"}}</td>
                                <td class="state">
                                    <img src="/agilito/backlog-state/{{ story.backlog_state }}.png"
                                        title="{{ story.backlog_state }}" alt="{{ story.backlog_state }}" />
                                </td>
                                <td id="edit_us_{{story.id}}" class="">
                                    <a href="{% url agilito.views.userstory_edit current_project.id,story.id %}?last_page={{last_page}}">
                                    <img src="/agilito/pencil.png" alt="edit" title="edit" width="16" height="16" /></a>
                                </td>
                                <td id="move_us_{{us.id}}" class="">
                                    <a href="{% url agilito.views.userstory_move current_project.id,story.id %}?last_page={{last_page}}"
                                        onclick="popup(this, 'us-move'); return false">
                                    <img src="/agilito/bullet_go.png" alt="move" title="move" width="16" height="16" /></a>
                                </td>
                                <td id="delete_us_{{story.id}}" class="">
                                    <a href="{% url agilito.views.userstory_delete current_project.id,story.id %}?last_page={{last_page}}">
                                    <img src="/agilito/delete.png" alt="delete" title="delete" width="16" height="16" /></a>
                                </td>
                            </tr>
                        {% endifequal %}
                    {%endfor%}
                </tbody>
            </table>
        {% else %}
            No user stories in the backlog.
        {% endif %}
    {% endblock %}
{% endif %}
